<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 동네 아파트 실거래가 대시보드</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .stat-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="text-slate-800">

    <div class="max-w-7xl mx-auto px-4 py-10">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-6">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">우리 동네 아파트 실거래가 대시보드</h1>
                <p class="text-slate-500 mt-2 text-lg">지정된 구글 시트 데이터를 기반으로 한 실시간 대시보드입니다.</p>
            </div>
            <div id="status-container">
                <span id="status-badge" class="px-4 py-2 rounded-full text-sm font-semibold bg-blue-50 text-blue-600 border border-blue-100 animate-pulse">
                    데이터 연결 중...
                </span>
            </div>
        </header>

        <!-- Error Banner -->
        <div id="error-banner" class="hidden mb-8 p-6 bg-red-50 border-2 border-red-200 rounded-2xl text-red-800">
            <div class="flex items-center mb-2">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                <h3 class="font-bold text-lg">데이터 로드 오류</h3>
            </div>
            <p id="error-message" class="text-sm opacity-90 leading-relaxed mb-2"></p>
            <div id="detected-headers" class="text-xs bg-white/50 p-2 rounded border border-red-100 mt-2 hidden">
                <span class="font-bold">감지된 시트 헤더:</span> <span id="header-list" class="font-mono"></span>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="stat-card">
                <p class="text-xs font-bold text-blue-500 uppercase tracking-wider mb-1">전체 거래 건수</p>
                <p id="total-count" class="text-3xl font-black">-</p>
            </div>
            <div class="stat-card">
                <p class="text-xs font-bold text-emerald-500 uppercase tracking-wider mb-1">평균 거래가</p>
                <div class="flex items-baseline gap-1">
                    <p id="avg-price" class="text-3xl font-black">-</p>
                    <span class="text-sm font-medium text-slate-400">만원</span>
                </div>
            </div>
            <div class="stat-card">
                <p class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-1">최고 거래가</p>
                <div class="flex items-baseline gap-1">
                    <p id="max-price" class="text-3xl font-black">-</p>
                    <span class="text-sm font-medium text-slate-400">만원</span>
                </div>
            </div>
            <div class="stat-card">
                <p class="text-xs font-bold text-rose-500 uppercase tracking-wider mb-1">최저 거래가</p>
                <div class="flex items-baseline gap-1">
                    <p id="min-price" class="text-3xl font-black">-</p>
                    <span class="text-sm font-medium text-slate-400">만원</span>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 mb-10">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                    월별 평균 거래가격 추이
                </h2>
                <span class="text-xs text-slate-400 font-medium">(단위: 만원)</span>
            </div>
            <div class="h-96">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Transaction Table -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-50 bg-slate-50/30">
                <h2 class="text-xl font-bold">상세 실거래 기록</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-slate-400 text-xs font-bold uppercase tracking-widest border-b border-slate-100">
                            <th class="px-8 py-5">거래일자</th>
                            <th class="px-8 py-5">아파트명</th>
                            <th class="px-8 py-5">법정동</th>
                            <th class="px-8 py-5">전용면적</th>
                            <th class="px-8 py-5">층</th>
                            <th class="px-8 py-5">건축년도</th>
                            <th class="px-8 py-5 text-right">거래금액(만원)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-50 text-sm">
                        <tr>
                            <td colspan="7" class="px-8 py-20 text-center text-slate-400 font-medium italic">
                                데이터를 불러오고 있습니다...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loader Overlay -->
    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mb-6"></div>
        <p class="text-slate-400 font-medium animate-pulse">실거래 데이터를 연결하는 중...</p>
    </div>

    <script>
        // 사용자가 제공한 특정 시트(gid)가 포함된 CSV URL
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSjs1b5A4Gpa4PtUU29bXQYvUEOEgbGEF8TqmuBY35Za7dsX-Td_nsavGZcxS-PDAmjmV_4EBJmck2/pub?gid=945303917&single=true&output=csv';

        let mainChart;

        // 숫자 처리 유틸리티
        function parsePrice(val) {
            if (val === undefined || val === null) return 0;
            const clean = String(val).replace(/[^0-9.]/g, '');
            return parseFloat(clean) || 0;
        }

        // 유연한 컬럼 매칭 함수
        function findValue(row, targetKey) {
            if (!row) return null;
            const keys = Object.keys(row);
            const normalize = (s) => s.replace(/[\s\(\)㎡]/g, '').toLowerCase();
            const targetNormalized = normalize(targetKey);
            
            const foundKey = keys.find(k => {
                const normalizedK = normalize(k);
                return normalizedK.includes(targetNormalized) || targetNormalized.includes(normalizedK);
            });
            return foundKey ? row[foundKey] : null;
        }

        async function init() {
            const badge = document.getElementById('status-badge');
            try {
                // 캐시 방지를 위해 타임스탬프 추가
                const fetchUrl = CSV_URL.includes('?') ? `${CSV_URL}&t=${Date.now()}` : `${CSV_URL}?t=${Date.now()}`;
                const response = await fetch(fetchUrl);
                
                if (!response.ok) throw new Error('구글 시트 서버 응답 실패. 시트 게시 상태를 확인하세요.');
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: 'greedy',
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            // 감지된 헤더 디버깅용 출력
                            const headers = Object.keys(results.data[0]);
                            document.getElementById('header-list').innerText = headers.join(', ');
                            
                            renderDashboard(results.data);
                            document.getElementById('loader').style.display = 'none';
                            badge.innerText = '데이터 실시간 연결됨';
                            badge.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100';
                        } else {
                            throw new Error('데이터 파싱 결과가 비어있습니다. 시트 내용을 확인하세요.');
                        }
                    },
                    error: function(err) {
                        throw new Error('CSV 파싱 중 오류: ' + err.message);
                    }
                });
            } catch (err) {
                showError(err.message);
            }
        }

        function showError(msg) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('error-message').innerText = msg;
            document.getElementById('detected-headers').classList.remove('hidden');
            const badge = document.getElementById('status-badge');
            badge.innerText = '연결 오류';
            badge.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-red-50 text-red-600 border border-red-100';
        }

        function renderDashboard(data) {
            const priceKey = '거래금액';
            const prices = data.map(d => parsePrice(findValue(d, priceKey))).filter(p => p > 0);
            
            if (prices.length === 0) {
                showError("'거래금액(만원)' 관련 컬럼을 찾을 수 없습니다. 시트의 헤더 명칭을 확인해 주세요.");
                return;
            }

            // 1. 요약 정보 업데이트
            document.getElementById('total-count').innerText = data.length.toLocaleString() + ' 건';
            document.getElementById('avg-price').innerText = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length).toLocaleString();
            document.getElementById('max-price').innerText = Math.max(...prices).toLocaleString();
            document.getElementById('min-price').innerText = Math.min(...prices).toLocaleString();

            // 2. 거래 목록 테이블 업데이트
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            
            // 거래일자 기준 내림차순 정렬 시도
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(findValue(a, '거래일자'));
                const dateB = new Date(findValue(b, '거래일자'));
                return dateB - dateA;
            });

            sortedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-8 py-4 font-medium text-slate-500">${findValue(item, '거래일자') || '-'}</td>
                    <td class="px-8 py-4 font-bold text-slate-900">${findValue(item, '아파트명') || '-'}</td>
                    <td class="px-8 py-4 text-slate-500">${findValue(item, '법정동') || '-'}</td>
                    <td class="px-8 py-4 text-slate-500">${findValue(item, '전용면적') || '-'}㎡</td>
                    <td class="px-8 py-4 text-slate-500">${findValue(item, '층') || '-'}층</td>
                    <td class="px-8 py-4 text-slate-500">${findValue(item, '건축년도') || '-'}</td>
                    <td class="px-8 py-4 text-right font-black text-blue-600">
                        ${parsePrice(findValue(item, priceKey)).toLocaleString()}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 3. 월별 차트 렌더링
            const monthly = {};
            data.forEach(item => {
                const date = findValue(item, '거래일자');
                if (date && String(date).length >= 7) {
                    const month = String(date).substring(0, 7);
                    const price = parsePrice(findValue(item, priceKey));
                    if (price > 0) {
                        if (!monthly[month]) monthly[month] = { sum: 0, count: 0 };
                        monthly[month].sum += price;
                        monthly[month].count += 1;
                    }
                }
            });

            const labels = Object.keys(monthly).sort();
            const values = labels.map(l => Math.round(monthly[l].sum / monthly[l].count));

            if (mainChart) mainChart.destroy();
            const ctx = document.getElementById('trendChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { 
                            grid: { borderDash: [5, 5], color: '#e2e8f0' },
                            ticks: { callback: v => v.toLocaleString() } 
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
